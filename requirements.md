# 要件定義書: Alt/BTC トレンドフォロー型レシオ戦略 自動売買システム

## 1. プロジェクト概要
本プロジェクトは、アルトコインバスケットとビットコイン（BTC）の価格比率（レシオ）を利用したトレンドフォロー型システムトレード戦略を自動化するシステムの構築を目的とする。市場の長期的なレジーム（強気・弱気）を判定し、その方向への短期的な価格乖離（Zスコア）を利用して順張りでエントリーを行う。

## 2. システム構成
システムは以下のモジュールで構成される。

1.  **データ収集モジュール**: 仮想通貨取引所またはデータプロバイダーから価格データ（OHLCV）を取得する。
2.  **戦略ロジックモジュール**: シグナル生成、レジーム判定、Zスコア計算を行う。
3.  **ポートフォリオ構築モジュール**: アルトコインのウェイト計算（Risk Parity）とBTCヘッジ比率の最適化を行う。
4.  **バックテスト・検証モジュール**: Walk-Forward Optimization (WFO) を用いた検証機能。
5.  **実行モジュール**: シグナルに基づき売買注文を生成（今回はバックテスト・シミュレーションを主眼とするが、実運用への拡張性を考慮）。

## 3. 戦略ロジック詳細

### 3.1. 投資対象 (Universe)
*   **Main Assets**: アルトコインバスケット
    *   *初期構成銘柄*: ETH, SOL, XRP, DOGE, ADA, DOT, MATIC, LTC
    *   *銘柄数*: 最小5銘柄、最大50銘柄。
    *   *選定基準*: 過去30日間の平均出来高が1,000万ドル以上の銘柄。
    *   *不足時の対応*: 候補が5銘柄未満の場合、出来高基準を10%ずつ緩和して再選定する。それでも不足する場合はエラー停止。
    *   *入れ替え頻度*: 四半期 (3ヶ月) ごとに見直し。
*   **Hedge Asset**: Bitcoin (BTC)

### 3.2. 指標計算 (Indicators)
1.  **レシオ (Ratio)**: `Ratio = Value(Altcoin Basket) / Price(BTC)`
2.  **長期移動平均線 (MA_Trend)**: レジーム判定用。
3.  **短期移動平均線 (MA_Short)**: Zスコア基準用。
4.  **Zスコア (Z-Score)**: `(Ratio - MA_Short) / StdDev(Ratio, short_window)`

### 3.3. レジーム判定 (Regime Definition)
*   **アルト強気 (Bullish)**: `Ratio > MA_Trend`
*   **アルト弱気 (Bearish)**: `Ratio < MA_Trend`
*   *レジーム変更時の挙動*: レジームが切り替わった瞬間、既存の逆方向ポジションは**即時決済 (Market Close)** する。
    *   *決済順序*: 全銘柄に対して成行注文を同時（非同期）に発行する。

### 3.4. 取引ルール (Trading Rules)
*   **パラメータ初期値**: `z_entry`=2.0, `z_target`=1.0, `z_stop`=3.0
*   **シグナル優先度**: 同一バーでBuy/Sellシグナルが競合した場合、**Sellシグナル（リスク回避）を優先**する。
*   **ポジション管理**: 単一ポジションのみ保持（ピラミッティングなし）。

#### A. 強気相場 (Bullish Regime)
*   Entry: `Z_Score < -z_entry` (Long)
*   Take Profit: `Z_Score > z_target`
*   Stop Loss: `abs(Z_Score) > z_stop`

#### B. 弱気相場 (Bearish Regime)
*   Entry: `Z_Score > z_entry` (Short)
*   Take Profit: `Z_Score < -z_target`
*   Stop Loss: `abs(Z_Score) > z_stop`

#### C. グローバル損切り
*   `abs(Z_Score) > z_stop` で即時決済。

### 3.5. ポートフォリオ構築・リバランス
*   **アルトコインウェイト**: Risk Parity
    *   *計算*: 各銘柄のボラティリティの逆数を計算し、**合計が1.0 (100%) になるよう正規化**する（レバレッジなし）。
    *   *更新頻度*: **月次 (Monthly)** でウェイトを再計算しリバランス。
*   **BTCヘッジ比率**: Beta-based Grid Search
    *   *探索範囲*: `[0.8, 0.9, 1.0, 1.1, 1.2] * beta` の5点探索。
    *   *更新頻度*: **四半期 (Quarterly)** のWFO再最適化時に更新。期間内は固定。

## 4. 異常系・エラー処理 (Error Handling)
*   **データ取得**:
    *   *初期化*: 初回起動時は取引所API (CCXT) から過去2年分のデータを取得する。
    *   *リトライ*: 最大3回。指数バックオフ (initial=1s)。
    *   *欠損補間*: 最大3期間までの連続欠損は `ffill` (前方埋め) で補間。それ以上はエラーとし、当該銘柄を除外または処理停止。
*   **WFOエラー**:
    *   データ期間が「In-Sample + Out-of-Sample」に満たない場合はエラー停止。
*   **データ不整合**:
    *   リトライ失敗時は処理を**停止 (Stop)** し、管理者にCriticalアラートを送信。

## 5. 非機能要件 (Non-Functional Requirements)

### 5.1. パフォーマンス・運用
*   **タイムゾーン**: 全て **UTC** 基準。日次バッチは **UTC 0:00** に実行。
*   **WFO設定**:
    *   In-Sample: 過去2年 (730日)
    *   Out-of-Sample: 直近3ヶ月 (90日)
    *   ローリング: 3ヶ月シフト。
*   **実行モード**: CLI引数 `--mode` で `backtest` / `live` を切り替え。
    *   `backtest`: 過去データを使用、約定はシミュレーション。
    *   `live`: 最新データを取得、シグナル生成のみ（今回は注文発注はモック）。

### 5.2. セキュリティ・ログ
*   **監査ログ**: CSV形式。
    *   *必須項目*: `timestamp`, `symbol`, `signal_type` (ENTRY/EXIT), `order_type`, `price`, `size`, `reason` (z_score値, regime等)。
*   **アクセス権限**: ログファイルは `chmod 600`。

### 5.3. 可用性
*   **通知**: Critical (処理停止) は Slack/Discord + Email。
*   **環境分離**: 設定ファイルで通知先を切り替え。

## 6. データライフサイクル (Data Lifecycle)
*   **削除ポリシー**: 計算済みデータ・ログは1年経過後にアーカイブ領域へ移動。
*   **コンプライアンス**: 個人情報は扱わない。
*   **バージョニング**: 結果はタイムスタンプ付きフォルダで管理。

## 7. 検証計画 (Validation Plan)
*   **Go/No-Go判定基準**:
    *   Out-of-Sample期間のシャープレシオ > 1.0
    *   最大ドローダウン < 20%
    *   *不合格時*: 自動運用には移行せず、**手動によるパラメータ再調整**フェーズへ戻る。
*   **コスト**:
    *   手数料: 0.11% (Entry/Exit双方)
    *   スリッページ: 0.05% (Entry/Exit双方)
*   **ポジションサイズ**: ポートフォリオ全体の100%を使用（レバレッジ1倍）。

## 8. 今後の展望・拡張性 (Future Roadmap)
1.  最適化指標の変更 (Sharpe, Calmar)
2.  ユニバースの動的拡張
3.  動的リスク管理
4.  MLによるレジーム判定
